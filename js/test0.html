<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title></title>
  </head>
  <body>
    <button onclick="send();" size=10>This is what I want to get working</button><br><br><br><br>

    <p>some other tests</p>
    <button onclick="testSend();" size=10>Send Test Tx (one per click / singe action) = working</button><br>
    <button onclick="testSend2();" size=10>Send Test Tx (3 per click / for loop) = timeout not working</button><br>

  </body>
  <script>


    var pkey = "*****pk here****";


    function roundUp(num, precision) {
      precision = Math.pow(10, precision)
      return Math.ceil(num * precision) / precision
    };

    function pad(num, size) {
        var s = num+"";
        while (s.length < size) s = "0" + s;
        return s;
    };

    function testSend(){

      var tx = {
          data: ["0x9902","0xAAAFFFFAAAFFFFAAAFFFFAAAFFFFAAAFFFFAAAFFFF"],
          cash: { key: pkey }
        }

      datacash.send(tx, function(err, res) {
              console.log("result",res);
            if (err){
              console.log(err);
            };
      });
    }

    function test(){console.log("test")}

    function testSend2(){
      var tx = {
          data: ["0x9902","0xAAAFFFFAAAFFFFAAAFFFFAAAFFFFAAAFFFFAAAFFFF"],
          cash: { key: pkey }
        }

      setTimeout(test,3000);
      for (i = 0; i < 5; i++) {
        console.log("send ",i)
        setTimeout(datacash.send(tx, function(err, res) {
                console.log("result",res);
              if (err){
                console.log(err);
              };
        }),2000);
      }
    }

    var testdata = [
  "000001011101001100010001000000000000000000000000",
  "000001100000001100010000000000000000000000000000",
  "000001100100001100001111000000000000000000000000",
  "000001101001001100001101000000000000000000000000",
  "000001101101001100001100000000000000000000000000",
  "000001110100001100001011000000000000000000000000",
  "000001111001001100001010000000000000000000000000",
  "000001111110001100001010000000000000000000000000",
  "000010000010001100001010000000000000000000000000",
  "000010000111001100001010000000000000000000000000",
  "000010001011001100001011000000000000000000000000",
  "000010001110001100001011000000000000000000000000",
  "000010010001001100001011000000000000000000000000",
  "000010010101001100001100000000000000000000000000",
  "000010011011001100001101000000000000000000000000",
  "000010011100001100001101000000000000000000000000",
  "000010100011001100001110000000000000000000000000",
  "000010100110001100001110000000000000000000000000",
  "000010101001001100001110000000000000000000000000",
  "000010101010001100001111000000000000000000000000",
  "000010101101001100001111000000000000000000000000",
  "000010110000001100001111000000000000000000000000",
  "000010110010001100010000000000000000000000000000",
  "000010110110001100010000000000000000000000000000",
  "000010111000001100010001000000000000000000000000",
  "000010111011001100010001000000000000000000000000",
  "000010111110001100010001000000000000000000000000",
  "000011000010001100010010000000000000000000000000",
  "000011000101001100010011000000000000000000000000",
  "000011001001001100010101000000000000000000000000",
  "000011001101001100010110000000000000000000000000",
  "000011010001001100010111000000000000000000000000",
  "000011010101001100011001000000000000000000000000",
  "000011011001001100011011000000000000000000000000",
  "000011100000001100011111000000000000000000000000",
  "000011100110001100100010000000000000000000000000",
  "000011101010001100100101000000000000000000000000",
  "000011101110001100100111000000000000000000000000",
  "000011110010001100101000000000000000000000000000",
  "000011110111001100101001000000000000000000000000",
  "000011111011001100101011000000000000000000000000",
  "000100000010001100101111000000000000000000000000",
  "000100000111001100110001000000000000000000000000",
  "000100001011001100110010000000000000000000000000",
  "000100001111001100110011000000000000000000000000",
  "000100010010001100110100000000000000000000000000",
  "000100010101001100110100000000000000000000000000",
  "000100011001001100110101000000000000000000000000",
  "000100011101001100110101000000000000000000000000",
  "000100100001001100110111000000000000000000000000",
  "000100100111001100110111000000000000000000000000",
  "000100101011001100110111000000000000000000000000",
  "000100110011001100110100000000000000000000000000",
  "000100110110001100110010000000000000000000000000",
  "000100111000001100110000000000000000000000000000",
  "000100111010001100101101000000000000000000000000",
  "000100111011001100101011000000000000000000000000",
  "000100111100001100101000000000000000000000000000",
  "000100111101001100100100000000000000000000000000",
  "000100111101001100100000000000000000000000000000",
  "000100111100001100011110000000000000000000000000",
  "000100111001001100011001000000000000000000000000",
  "000100110100001100010100000000000000000000000000",
  "000100101101001100001010000000000000000000000000",
  "000100100110001100000101000000000000000000000000",
  "000100100001001100000000000000000000000000000000",
  "000100011011001011111011000000000000000000000000",
  "000100010111001011111000000000000000000000000000",
  "000100010011001011110111000000000000000000000000",
  "000100010001001011110110000000000000000000000000",
  "000100001101001011110110000000000000000000000000",
  "000100001011001011110110000000000000000000000000",
  "000100001001001011110111000000000000000000000000",
  "000100000110001011111000000000000000000000000000",
  "000100000100001011111010000000000000000000000000",
  "000100000000001011111110000000000000000000000000",
  "000011111100001100000010000000000000000000000000",
  "000011110110001100001000000000000000000000000000",
  "000011101101001100010100000000000000000000000000",
  "000011101000001100011011000000000000000000000000",
  "000011100010001100100010000000000000000000000000",
  "000011100000001100100111000000000000000000000000",
  "000011011110001100101100000000000000000000000000",
  "000011011101001100101111000000000000000000000000",
  "000011011101001100110101000000000000000000000000",
  "000011011101001100111001000000000000000000000000",
  "000011011101001100111101000000000000000000000000",
  "000011011101001101000001000000000000000000000000",
  "000011011011001101000110000000000000000000000000",
  "000011011000001101001101000000000000000000000000",
  "000011010100001101010010000000000000000000000000",
  "000011001111001101010111000000000000000000000000",
  "000011001001001101011100000000000000000000000000",
  "000011000111001101011110000000000000000000000000",
  "000011000100001101011111000000000000000000000000",
  "000011000001001101011111000000000000000000000000",
  "000010111101001101011111000000000000000000000000",
  "000010111001001101011111000000000000000000000000",
  "000010110010001101011101000000000000000000000000",
  "000010101110001101011100000000000000000000000000",
  "000010101011001101011011000000000000000000000000",
  "000010101001001101011010000000000000000000000000",
  "000010101000001101011000000000000000000000000000",
  "000010100111001101011000000000000000000000000000",
  "000010100110001101010110000000000000000000000000",
  "000010100110001101010100000000000000000000000000",
  "000010100110001101010011000000000000000000000000",
  "000010100111001101010000000000000000000000000000",
  "000010101010001101001110000000000000000000000000",
  "000010101110001101001011000000000000000000000000",
  "000010110010001101001000000000000000000000000000",
  "000010110110001101000101000000000000000000000000",
  "000010111001001101000010000000000000000000000000",
  "000010111100001101000001000000000000000000000000",
  "000010111110001100111111000000000000000000000000",
  "000011000000001100111111000000000000000000000000",
  "000011000001001100111110000000000000000000000000",
  "000011000011001100111110000000000000000000000000",
  "000011000100001100111110000000000000000000000000",
  "000011000101001100111110000000000000000000000000",
  "000011000110001100111110000000000000000000000000",
  "000011000111001100111110000000000000000000000000"
]

    function send(){
      var pixelsToSend = testdata;
      var prefix = "0x8801"
      var roundCapacity = 36

      var rounds = roundUp(pixelsToSend.length / roundCapacity, 0)
      console.log("SendRounds:",rounds)

      var startPos = 0
      for (count = 1; count <= rounds; count++){
        var endPos = startPos+roundCapacity
        var hexPayload = []
        var batch = pixelsToSend.slice(startPos,endPos)
        for (pixel in batch){
          var hexPixel = pad(parseInt(batch[pixel], 2).toString(16),12).toUpperCase();
          hexPayload.push(hexPixel)
        }

        hexPayload = hexPayload.join("")
        console.log("payload:",hexPayload)

        var tx = {
            data: [prefix,"0x"+hexPayload],
            cash: { key: pkey }
          }

        datacash.send(tx, function(err, res) {
                console.log("result",res);
              if (err){
                console.log(err);
              };
        });



        startPos = endPos;
      }
    }
  </script>
  <script src='https://unpkg.com/datacash'></script>
</html>
